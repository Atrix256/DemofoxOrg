<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>2D Point Set Frequencies</title>
<style type="text/css">
body { color: #00FF00; background-color:black;}
canvas.html5 {border:2px solid #00FF00;}
</style>
<script>

var g_controlPoints =
[
	[0.1, 0.6],
	[0.5, 0.5],
	[0.7, 0.3],
];

var g_graphPanel;
var g_canvas;
var g_graphPanel2;
var g_canvas2;
var g_mousePos = [0,0];
var g_pointDragged = -1;
var g_lastDragPos = [0,0];

var g_numFrequenciesX = 4;
var g_numFrequenciesY = 4;

var g_stepSize = 0.001;
var g_stepCount = 10;

var g_controlPointSize = 15

var g_increaseFreqOnClick = true;

function onPageLoaded()
{
	g_graphPanel = setupCanvas('Graph');
	g_canvas = document.getElementById('Graph');
	g_canvas.addEventListener('mousemove', function(evt) {OnMouseMove(evt);RedrawGraph();}, false);
	g_canvas.addEventListener('mousedown', function() {OnMouseDown();RedrawGraph();}, false);
	g_canvas.addEventListener('mouseup', function() {OnMouseUp();RedrawGraph();}, false);
	g_canvas.addEventListener('dblclick', function() {OnDoubleClick();RedrawGraph();}, false);

	g_graphPanel2 = setupCanvas('Graph2');
	g_canvas2 = document.getElementById('Graph2');
	g_canvas2.addEventListener('click', function(evt) {OnClickFrequency(GetMousePos(g_canvas2, event));RedrawGraph();}, false);
	RedrawGraph();
}

function setupCanvas(name)
{
  // Get a reference to the element.
  var elem = document.getElementById(name);

  // Always check for properties and methods, to make sure your code doesn't break 
  // in other browsers.
  if (elem)
  {
    if(elem.getContext)
    {
      // Get the 2d context.
      // Remember: you can only initialize one context per element.
      var context = elem.getContext('2d');

      if (context)
      {
      	return {"elem":elem, "context":context, "clear":function(){ClearImageBuffer(context, elem)}, "fill":function(color){FillImageBuffer(context, color)}};
      }
      else
      {
      	alert("Could not get html5 2d context, your browser doesn't support it! Try firefox or chrome");
      }
    }
    else
    {
      alert("The getContext function was missing, your browser doesn't support it! Try firefox or chrome"); 
    }
  }
  else
  {
    alert("Could not get element 'MainCanvas'");	
  }

  return false;
}

function GetMousePos(canvas, evt)
{
	var rect = canvas.getBoundingClientRect();
	var pos =
	[
		evt.clientX - rect.left,
		evt.clientY - rect.top
	];
	return pos;
}

function ScreenPointToMathPoint(x,y)
{
	mathPointMinX = -0.1;
	mathPointMaxX = 1.1;
	mathPointMinY = 1.1;
	mathPointMaxY = -0.1;

	var point = [x / g_graphPanel.elem.width,y / g_graphPanel.elem.height];

	point[0] = point[0] * (mathPointMaxX - mathPointMinX) + mathPointMinX;
	point[1] = point[1] * (mathPointMaxY - mathPointMinY) + mathPointMinY;

	return point;
}

function MathPointToScreenPoint(x,y)
{
	mathPointMinX = -0.1;
	mathPointMaxX = 1.1;
	mathPointMinY = 1.1;
	mathPointMaxY = -0.1;

	var point = [x,y];
	point[0] = (point[0] - mathPointMinX) / (mathPointMaxX - mathPointMinX);
	point[1] = (point[1] - mathPointMinY) / (mathPointMaxY - mathPointMinY);

	point[0] = point[0] * g_graphPanel.elem.width;
	point[1] = point[1] * g_graphPanel.elem.height;

	return point;
}

function OnMouseMove(evt)
{
	g_mousePos = GetMousePos(g_canvas, evt);
	if (g_pointDragged == -1)
		return;

	var mouseMath = ScreenPointToMathPoint(g_mousePos[0], g_mousePos[1]);
	var lastMath = ScreenPointToMathPoint(g_lastDragPos[0], g_lastDragPos[1]);
	var delta = [mouseMath[0] - lastMath[0], mouseMath[1] - lastMath[1]];

	g_lastDragPos = g_mousePos;

	g_controlPoints[g_pointDragged][0] += delta[0];
	g_controlPoints[g_pointDragged][1] += delta[1];

	if(g_controlPoints[g_pointDragged][0] < 0.0)
		g_controlPoints[g_pointDragged][0] = 0.0;
	else if(g_controlPoints[g_pointDragged][0] > 1.0)
		g_controlPoints[g_pointDragged][0] = 1.0;

	if(g_controlPoints[g_pointDragged][1] < 0.0)
		g_controlPoints[g_pointDragged][1] = 0.0;
	else if(g_controlPoints[g_pointDragged][1] > 1.0)
		g_controlPoints[g_pointDragged][1] = 1.0;
}

function OnMouseDown()
{
	g_lastDragPos = g_mousePos;

	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var point = MathPointToScreenPoint(g_controlPoints[i][0], g_controlPoints[i][1]);
		var dist = Math.sqrt((point[1]-g_mousePos[1])*(point[1]-g_mousePos[1]) + (point[0]-g_mousePos[0])*(point[0]-g_mousePos[0]));
		if (dist < g_controlPointSize)
		{
			g_pointDragged = i;
			return;
		}		
	}

	g_pointDragged = -1;
}

function OnMouseUp()
{
	g_pointDragged = -1;
}

function clearSelection() {
    if(document.selection && document.selection.empty) {
        document.selection.empty();
    } else if(window.getSelection) {
        var sel = window.getSelection();
        sel.removeAllRanges();
    }
}

function OnDoubleClick()
{
	clearSelection();
	g_pointDragged = -1;

	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var point = MathPointToScreenPoint(g_controlPoints[i][0], g_controlPoints[i][1]);
		var dist = Math.sqrt((point[1]-g_mousePos[1])*(point[1]-g_mousePos[1]) + (point[0]-g_mousePos[0])*(point[0]-g_mousePos[0]));
		if (dist < g_controlPointSize)
		{
			g_controlPoints.splice(i,1);
			return;
		}		
	}
	var mathPoint = ScreenPointToMathPoint(g_mousePos[0], g_mousePos[1]);
	g_controlPoints.push([mathPoint[0], mathPoint[1]]);
}

//hook up our event listener
window.addEventListener('load', function(){onPageLoaded();}, false);

function ClearImageBuffer(context, elem)
{
	context.fillStyle   = "#000000";
	context.fillRect(0, 0, elem.width, elem.height);
}

function FillImageBuffer(context, color)
{
	context.fillStyle   = color;
	context.fillRect(0, 0, g_graphPanel.elem.width, g_graphPanel.elem.height);
}

function DrawControlPoint(X, Y, dragging)
{
	var dist = Math.sqrt((Y-g_mousePos[1])*(Y-g_mousePos[1]) +  (X-g_mousePos[0])*(X-g_mousePos[0]));
	var highlite = dist < g_controlPointSize;

	g_graphPanel.context.beginPath();
	g_graphPanel.context.arc(X, Y, 10, 0, 2 * Math.PI, false);
	g_graphPanel.context.fillStyle = dragging ? '#FF8888' : (highlite ? '#FF4030' : '#FF0000');
	g_graphPanel.context.fill();
	g_graphPanel.context.lineWidth = 3;
	g_graphPanel.context.strokeStyle = dragging ? '#888888' : (highlite ? '#884030' : '#880000');
	g_graphPanel.context.stroke();	
}

function DMagDPointX(hzX, hzY, pointIndex)
{
	re = 0.0;
	im = 0.0;
	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var param = 2.0 * Math.PI * (hzX * g_controlPoints[i][0] + hzY * g_controlPoints[i][1]);
		re += Math.cos(param);
		im += Math.sin(param);
	}	

	var param = 2.0 * Math.PI * (hzX * g_controlPoints[pointIndex][0]);

	re *= -4 * Math.PI * hzX * Math.sin(param);
	im *= 4 * Math.PI * hzX * Math.cos(param);

	re /=  g_controlPoints.length;
	im /=  g_controlPoints.length;

	return re;
}

function DMagDPointY(hzX, hzY, pointIndex)
{
	re = 0.0;
	im = 0.0;
	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var param = 2.0 * Math.PI * (hzX * g_controlPoints[i][0] + hzY * g_controlPoints[i][1]);
		re += Math.cos(param);
		im += Math.sin(param);
	}	

	var param = 2.0 * Math.PI * (hzY * g_controlPoints[pointIndex][1]);

	re *= -4 * Math.PI * hzY * Math.sin(param);
	im *= 4 * Math.PI * hzY * Math.cos(param);

	re /=  g_controlPoints.length;
	im /=  g_controlPoints.length;

	return re;
}

function GetGradient(hzX, hzY)
{
		var gradient = [];
		var length = [0.0, 0.0];

		for (var pointIndex = 0; pointIndex < g_controlPoints.length; ++pointIndex)
		{
			dmdp = [DMagDPointX(hzY, hzY, pointIndex), DMagDPointY(hzY, hzY, pointIndex)];
			length[0] += dmdp[0] * dmdp[0];
			length[1] += dmdp[1] * dmdp[1];
			gradient.push(dmdp);
		}

		for (var i = 0; i < 2; i++)
		{
			if (length[i] <= 0)
			{
				for (var j = 0; j < g_controlPoints.length; j++)
					gradient[j][i] = 0;
			}
			else
			{
				length[i] = Math.sqrt(length[i]);
				for (var j = 0; j < g_controlPoints.length; j++)
					gradient[j][i] = gradient[j][i] / length[i];
			}
		}

		return gradient;
}

function AdjustFrequency(hzX, hzY, multiplier)
{
	for (var ij = 0; ij < g_stepCount; ij++)
	{
		var gradient = GetGradient(hzX, hzY);
		if (gradient.length == 0)
			return;

		for (var pointIndex = 0; pointIndex < g_controlPoints.length; ++pointIndex)
		{
			g_controlPoints[pointIndex][0] = (g_controlPoints[pointIndex][0] + gradient[pointIndex][0] * multiplier * g_stepSize + 10) % 1;
			g_controlPoints[pointIndex][1] = (g_controlPoints[pointIndex][1] + gradient[pointIndex][1] * multiplier * g_stepSize + 10) % 1;
		}
	}

	RedrawGraph();
}

function RedrawGraph()
{
	// clear the graph panel
	g_graphPanel.clear();

	// draw 1/2 grid lines
	g_graphPanel.context.strokeStyle='#00FF00';	
	g_graphPanel.context.lineWidth = 1;
	g_graphPanel.context.beginPath();
	var PA = MathPointToScreenPoint( 0.5, 0.0);
	var PB = MathPointToScreenPoint( 0.5, 1.0);
	g_graphPanel.context.moveTo(PA[0], PA[1]);
	g_graphPanel.context.lineTo(PB[0], PB[1]);
	var PA = MathPointToScreenPoint( 0.0, 0.5);
	var PB = MathPointToScreenPoint( 1.0, 0.5);
	g_graphPanel.context.moveTo(PA[0], PA[1]);
	g_graphPanel.context.lineTo(PB[0], PB[1]);	
	g_graphPanel.context.stroke();

	// draw 1/4 grid lines
	g_graphPanel.context.strokeStyle='#004000';	
	g_graphPanel.context.lineWidth = 1;
	g_graphPanel.context.beginPath();
	var PA = MathPointToScreenPoint( 0.25, 0.0);
	var PB = MathPointToScreenPoint( 0.25, 1.0);
	g_graphPanel.context.moveTo(PA[0], PA[1]);
	g_graphPanel.context.lineTo(PB[0], PB[1]);
	var PA = MathPointToScreenPoint( 0.75, 0.0);
	var PB = MathPointToScreenPoint( 0.75, 1.0);
	g_graphPanel.context.moveTo(PA[0], PA[1]);
	g_graphPanel.context.lineTo(PB[0], PB[1]);
	var PA = MathPointToScreenPoint( 0.0, 0.25);
	var PB = MathPointToScreenPoint( 1.0, 0.25);
	g_graphPanel.context.moveTo(PA[0], PA[1]);
	g_graphPanel.context.lineTo(PB[0], PB[1]);
	var PA = MathPointToScreenPoint( 0.0, 0.75);
	var PB = MathPointToScreenPoint( 1.0, 0.75);
	g_graphPanel.context.moveTo(PA[0], PA[1]);
	g_graphPanel.context.lineTo(PB[0], PB[1]);	
	g_graphPanel.context.stroke();


	// draw a box around [0,1]
	g_graphPanel.context.strokeStyle='#0000FF';	
	g_graphPanel.context.lineWidth = 1;
	g_graphPanel.context.beginPath();

	P00 = MathPointToScreenPoint( 0, 0);
	P10 = MathPointToScreenPoint( 1, 0);
	P01 = MathPointToScreenPoint( 0, 1);
	P11 = MathPointToScreenPoint( 1, 1);

	g_graphPanel.context.moveTo(P00[0], P00[1]);
	g_graphPanel.context.lineTo(P10[0], P10[1]);
	g_graphPanel.context.lineTo(P11[0], P11[1]);
	g_graphPanel.context.lineTo(P01[0], P01[1]);
	g_graphPanel.context.lineTo(P00[0], P00[1]);
	g_graphPanel.context.stroke();

	// draw the control points
	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var point = MathPointToScreenPoint(g_controlPoints[i][0], g_controlPoints[i][1]);
		DrawControlPoint(point[0], point[1], g_pointDragged == i);
	}

	var mags = new Array(g_numFrequenciesX);
	for (var ix = 1; ix <= g_numFrequenciesX; ix++)
		mags[ix] = new Array(g_numFrequenciesY);
	var maxmag = 1.0;

	// make the data
	for (var iy = 1; iy <= g_numFrequenciesY; iy++)
	{
		for (var ix = 1; ix <= g_numFrequenciesX; ix++)
		{		    
		    re = 0.0;
		    im = 0.0;
		    for (pointIndex = 0; pointIndex < g_controlPoints.length; ++pointIndex)
		    {
		    	var param = 2.0 * Math.PI * (ix * g_controlPoints[pointIndex][0] + iy * g_controlPoints[pointIndex][1]);
		    	re += Math.cos(param) / g_controlPoints.length;
		    	im += Math.sin(param) / g_controlPoints.length;
		    }
		    mag = Math.sqrt(re*re + im*im);
		    phase = Math.atan2(im, re);
		    if (phase < 0)
		    	phase += 2 * Math.PI;
		    phase *= 180.0 / Math.PI;

		    mags[ix][iy] = mag;

		    if (mag > maxmag)
		    	maxmag = mag;
		}
	}

	for (var iy = 1; iy <= g_numFrequenciesY; iy++)
		for (var ix = 1; ix <= g_numFrequenciesX; ix++)
			mags[ix][iy] /= maxmag;	

	// start the drawing
	g_graphPanel2.clear();	

	for (var iy = 0; iy < g_numFrequenciesY; iy++)
	{
		y1 = g_graphPanel2.elem.height * iy / (g_numFrequenciesY);
		y2 = g_graphPanel2.elem.height * (iy+1) / (g_numFrequenciesY);

		for (var ix = 0; ix < g_numFrequenciesX; ix++)
		{
			x1 = g_graphPanel2.elem.width * ix / (g_numFrequenciesX);
			x2 = g_graphPanel2.elem.width * (ix+1) / (g_numFrequenciesX);

			var color = mags[ix+1][iy+1] * 255;

	  	g_graphPanel2.context.fillStyle = "rgb(" + color + ", " + color + ", "+ color + ")";
			g_graphPanel2.context.fillRect(x1, y1, x2-x1, y2-y1);

		}
	}

  g_graphPanel2.context.font = '20px serif';
  g_graphPanel2.context.fillStyle='#00FF00';	
	g_graphPanel2.context.fillText("(0,0)", 5, 25);  

	// list the points
	var pointsText = document.getElementById("pointsText");
	var thePoints = "Points: ";
	for (var i = 0; i < g_controlPoints.length; ++i)
	{
		if (i == 0)
			thePoints += "[" + String(g_controlPoints[i][0].toFixed(3)) + ", " + String(g_controlPoints[i][1].toFixed(3)) + "]";
		else
			thePoints += ", [" + String(g_controlPoints[i][0].toFixed(3)) + ", " + String(g_controlPoints[i][1].toFixed(3)) + "]";
	}

	thePoints += "<br><br><b><u>Normalized Gradients</u></b>"
	for (var iy = 1; iy <= g_numFrequenciesY; iy++)
	{
		for (var ix = 1; ix <= g_numFrequenciesX; ix++)
		{
			var gradient = GetGradient(ix, iy);
			thePoints += "<br><br>[" + String(ix) + ", "+ String(iy) + "] hz: ["
			for (var j = 0; j < gradient.length; ++j)
			{
				if (j == 0)
					thePoints += "[" + String(gradient[j][0].toFixed(2)) + ", " + String(gradient[j][1].toFixed(2)) + "]";
				else
					thePoints += ", [" + String(gradient[j][0].toFixed(2)) + ", " + String(gradient[j][1].toFixed(2)) + "]";
			}
			thePoints += "]";
		}
	}

	pointsText.innerHTML = thePoints;	
}

function OnClickFreqChange()
{
	g_increaseFreqOnClick = (document.getElementById("OnClickFreq").value == "Increase");
}

function OnClickFrequency(mousePos)
{
	var hzX = Math.max(Math.min(Math.floor(mousePos[0] * g_numFrequenciesX / 400), g_numFrequenciesX-1), 0);
	var hzY = Math.max(Math.min(Math.floor(mousePos[1] * g_numFrequenciesY / 400), g_numFrequenciesX-1), 0);
	AdjustFrequency(hzX, hzY, g_increaseFreqOnClick ? 1.0 : -1.0);
}

</script>
</head>
<body>
<h1>2D Point Set Frequencies</h1>
<b>Click and drag points.  Double click on a point to remove it.  Double click on an empty space to add a point. Click on frequency cell to increase or decrease frequency magnitude.</b><br/><br/>
<table>
	<tr>
		<td>
			<canvas class="html5" id="Graph" width="400" height="400">Your browser doesn't seem to support the necesary html5 features ):</canvas>
		</td>
		<td>
			<canvas class="html5" id="Graph2" width="400" height="400">Your browser doesn't seem to support the necesary html5 features ):</canvas>
		</td>
	</tr>
</table>
<table style="border: 1px solid #00FF00">
	<tr>
		<td>Max Frequency X:</td>
		<td><input type="text" id="numFrequenciesX" value="4" onchange="val = parseInt(document.getElementById('numFrequenciesX').value); document.getElementById('numFrequenciesX').value = val; g_numFrequenciesX = val; RedrawGraph();" /></td>
	</tr>
	<tr>
		<td>Max Frequency Y:</td>
		<td><input type="text" id="numFrequenciesY" value="4" onchange="val = parseInt(document.getElementById('numFrequenciesY').value); document.getElementById('numFrequenciesY').value = val; g_numFrequenciesY = val; RedrawGraph();" /></td>
	</tr>	
	<tr>
		<td>On Click</td>
		<td>
			<select name="OnClickFreq" id="OnClickFreq" onChange="OnClickFreqChange();">
				<option value="Increase">Increase Frequency</option>
				<option value="Decrease">Decrease Frequency</option>
			</select>
		</td>
	</tr>
	<tr>
		<td>Step Size:</td>
		<td><input type="text" id="stepSize" value="0.001" onchange="val = parseFloat(document.getElementById('stepSize').value); document.getElementById('stepSize').value = val; g_stepSize = val;  RedrawGraph();" /></td>
	</tr>
	<tr>
		<td>Step Count:</td>
		<td><input type="text" id="stepCount" value="10" onchange="val = parseInt(document.getElementById('stepCount').value); document.getElementById('stepCount').value = val; g_stepCount = val;  RedrawGraph();" /></td>
	</tr>		
</table>
<br>
<div id="pointsText"></div>
</body></html>

TODO: presets
TODO: make the frequency adjustments work correctly