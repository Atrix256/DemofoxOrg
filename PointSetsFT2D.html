<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>2D Point Set Frequencies</title>
<style type="text/css">
body { color: #00FF00; background-color:black;}
canvas.html5 {border:2px solid #00FF00;}
</style>
<script>

var g_controlPoints =
[
	[0.1, 0.6],
	[0.5, 0.5],
	[0.7, 0.3],
];

var g_graphPanel;
var g_canvas;
var g_graphPanel2;
var g_canvas2;
var g_mousePos = [0,0];
var g_pointDragged = -1;
var g_lastDragPos = [0,0];

var g_numFrequenciesX = 8;
var g_numFrequenciesY = 8;

var g_controlPointSize = 15

function onPageLoaded()
{
	g_graphPanel = setupCanvas('Graph');
	g_canvas = document.getElementById('Graph');
	g_canvas.addEventListener('mousemove', function(evt) {OnMouseMove(evt);RedrawGraph();}, false);
	g_canvas.addEventListener('mousedown', function() {OnMouseDown();RedrawGraph();}, false);
	g_canvas.addEventListener('mouseup', function() {OnMouseUp();RedrawGraph();}, false);
	g_canvas.addEventListener('dblclick', function() {OnDoubleClick();RedrawGraph();}, false);

	g_graphPanel2 = setupCanvas('Graph2');
	g_canvas2 = document.getElementById('Graph2');	
	RedrawGraph();
}

function setupCanvas(name)
{
  // Get a reference to the element.
  var elem = document.getElementById(name);

  // Always check for properties and methods, to make sure your code doesn't break 
  // in other browsers.
  if (elem)
  {
    if(elem.getContext)
    {
      // Get the 2d context.
      // Remember: you can only initialize one context per element.
      var context = elem.getContext('2d');

      if (context)
      {
      	return {"elem":elem, "context":context, "clear":function(){ClearImageBuffer(context, elem)}, "fill":function(color){FillImageBuffer(context, color)}};
      }
      else
      {
      	alert("Could not get html5 2d context, your browser doesn't support it! Try firefox or chrome");
      }
    }
    else
    {
      alert("The getContext function was missing, your browser doesn't support it! Try firefox or chrome"); 
    }
  }
  else
  {
    alert("Could not get element 'MainCanvas'");	
  }

  return false;
}

function GetMousePos(canvas, evt)
{
	var rect = g_canvas.getBoundingClientRect();
	var pos =
	[
		evt.clientX - rect.left,
		evt.clientY - rect.top
	];
	return pos;
}

function ScreenPointToMathPoint(x,y)
{
	mathPointMinX = -0.1;
	mathPointMaxX = 1.1;
	mathPointMinY = 1.1;
	mathPointMaxY = -0.1;

	var point = [x / g_graphPanel.elem.width,y / g_graphPanel.elem.height];

	point[0] = point[0] * (mathPointMaxX - mathPointMinX) + mathPointMinX;
	point[1] = point[1] * (mathPointMaxY - mathPointMinY) + mathPointMinY;

	return point;
}

function MathPointToScreenPoint(x,y)
{
	mathPointMinX = -0.1;
	mathPointMaxX = 1.1;
	mathPointMinY = 1.1;
	mathPointMaxY = -0.1;

	var point = [x,y];
	point[0] = (point[0] - mathPointMinX) / (mathPointMaxX - mathPointMinX);
	point[1] = (point[1] - mathPointMinY) / (mathPointMaxY - mathPointMinY);

	point[0] = point[0] * g_graphPanel.elem.width;
	point[1] = point[1] * g_graphPanel.elem.height;

	return point;
}

function OnMouseMove(evt)
{
	g_mousePos = GetMousePos(g_canvas, evt);
	if (g_pointDragged == -1)
		return;

	var mouseMath = ScreenPointToMathPoint(g_mousePos[0], g_mousePos[1]);
	var lastMath = ScreenPointToMathPoint(g_lastDragPos[0], g_lastDragPos[1]);
	var delta = [mouseMath[0] - lastMath[0], mouseMath[1] - lastMath[1]];

	g_lastDragPos = g_mousePos;

	g_controlPoints[g_pointDragged][0] += delta[0];
	g_controlPoints[g_pointDragged][1] += delta[1];

	if(g_controlPoints[g_pointDragged][0] < 0.0)
		g_controlPoints[g_pointDragged][0] = 0.0;
	else if(g_controlPoints[g_pointDragged][0] > 1.0)
		g_controlPoints[g_pointDragged][0] = 1.0;

	if(g_controlPoints[g_pointDragged][1] < 0.0)
		g_controlPoints[g_pointDragged][1] = 0.0;
	else if(g_controlPoints[g_pointDragged][1] > 1.0)
		g_controlPoints[g_pointDragged][1] = 1.0;
}

function OnMouseDown()
{
	g_lastDragPos = g_mousePos;

	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var point = MathPointToScreenPoint(g_controlPoints[i][0], g_controlPoints[i][1]);
		var dist = Math.sqrt((point[1]-g_mousePos[1])*(point[1]-g_mousePos[1]) + (point[0]-g_mousePos[0])*(point[0]-g_mousePos[0]));
		if (dist < g_controlPointSize)
		{
			g_pointDragged = i;
			return;
		}		
	}

	g_pointDragged = -1;
}

function OnMouseUp()
{
	g_pointDragged = -1;
}

function clearSelection() {
    if(document.selection && document.selection.empty) {
        document.selection.empty();
    } else if(window.getSelection) {
        var sel = window.getSelection();
        sel.removeAllRanges();
    }
}

function OnDoubleClick()
{
	clearSelection();
	g_pointDragged = -1;

	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var point = MathPointToScreenPoint(g_controlPoints[i][0], g_controlPoints[i][1]);
		var dist = Math.sqrt((point[1]-g_mousePos[1])*(point[1]-g_mousePos[1]) + (point[0]-g_mousePos[0])*(point[0]-g_mousePos[0]));
		if (dist < g_controlPointSize)
		{
			g_controlPoints.splice(i,1);
			return;
		}		
	}
	var mathPoint = ScreenPointToMathPoint(g_mousePos[0], g_mousePos[1]);
	g_controlPoints.push([mathPoint[0], mathPoint[1]]);
}

//hook up our event listener
window.addEventListener('load', function(){onPageLoaded();}, false);

function ClearImageBuffer(context, elem)
{
	context.fillStyle   = "#000000";
	context.fillRect(0, 0, elem.width, elem.height);
}

function FillImageBuffer(context, color)
{
	context.fillStyle   = color;
	context.fillRect(0, 0, g_graphPanel.elem.width, g_graphPanel.elem.height);
}

function DrawControlPoint(X, Y, dragging)
{
	var dist = Math.sqrt((Y-g_mousePos[1])*(Y-g_mousePos[1]) +  (X-g_mousePos[0])*(X-g_mousePos[0]));
	var highlite = dist < g_controlPointSize;

	g_graphPanel.context.beginPath();
	g_graphPanel.context.arc(X, Y, 10, 0, 2 * Math.PI, false);
	g_graphPanel.context.fillStyle = dragging ? '#FF8888' : (highlite ? '#FF4030' : '#FF0000');
	g_graphPanel.context.fill();
	g_graphPanel.context.lineWidth = 3;
	g_graphPanel.context.strokeStyle = dragging ? '#888888' : (highlite ? '#884030' : '#880000');
	g_graphPanel.context.stroke();	
}

function RedrawGraph()
{
	// clear the graph panel
	g_graphPanel.clear();

	// draw a box around [0,1]
	g_graphPanel.context.strokeStyle='#0000FF';	
	g_graphPanel.context.lineWidth = 1;
	g_graphPanel.context.beginPath();

	P00 = MathPointToScreenPoint( 0, 0);
	P10 = MathPointToScreenPoint( 1, 0);
	P01 = MathPointToScreenPoint( 0, 1);
	P11 = MathPointToScreenPoint( 1, 1);

	g_graphPanel.context.moveTo(P00[0], P00[1]);
	g_graphPanel.context.lineTo(P10[0], P10[1]);
	g_graphPanel.context.lineTo(P11[0], P11[1]);
	g_graphPanel.context.lineTo(P01[0], P01[1]);
	g_graphPanel.context.lineTo(P00[0], P00[1]);
	g_graphPanel.context.stroke();

	// draw the control points
	for (i = 0; i < g_controlPoints.length; ++i)
	{
		var point = MathPointToScreenPoint(g_controlPoints[i][0], g_controlPoints[i][1]);
		DrawControlPoint(point[0], point[1], g_pointDragged == i);
	}

	var mags = new Array(g_numFrequenciesX);
	for (var ix = 1; ix <= g_numFrequenciesX; ix++)
		mags[ix] = new Array(g_numFrequenciesY);
	var maxmag = 1.0;

	// make the data
	for (var iy = 1; iy <= g_numFrequenciesY; iy++)
	{
		for (var ix = 1; ix <= g_numFrequenciesX; ix++)
		{		    
		    re = 0.0;
		    im = 0.0;
		    for (pointIndex = 0; pointIndex < g_controlPoints.length; ++pointIndex)
		    {
		    	re += Math.cos(2.0 * Math.PI * ix * g_controlPoints[pointIndex][0]) * Math.cos(2.0 * Math.PI * iy * g_controlPoints[pointIndex][1]) / g_controlPoints.length;
		    	im += Math.sin(2.0 * Math.PI * ix * g_controlPoints[pointIndex][0]) * Math.sin(2.0 * Math.PI * iy * g_controlPoints[pointIndex][1]) / g_controlPoints.length;
		    }
		    mag = Math.sqrt(re*re + im*im);
		    phase = Math.atan2(im, re);
		    if (phase < 0)
		    	phase += 2 * Math.PI;
		    phase *= 180.0 / Math.PI;

		    mags[ix][iy] = mag;

		    if (mag > maxmag)
		    	maxmag = mag;
		}
	}

	for (var iy = 1; iy <= g_numFrequenciesY; iy++)
		for (var ix = 1; ix <= g_numFrequenciesX; ix++)
			mags[ix][iy] /= maxmag;	

	// start the drawing
	g_graphPanel2.clear();	

	for (var iy = 0; iy < g_numFrequenciesY; iy++)
	{
		y1 = g_graphPanel2.elem.height * iy / (g_numFrequenciesY);
		y2 = g_graphPanel2.elem.height * (iy+1) / (g_numFrequenciesY);

		for (var ix = 0; ix < g_numFrequenciesX; ix++)
		{
			x1 = g_graphPanel2.elem.width * ix / (g_numFrequenciesX);
			x2 = g_graphPanel2.elem.width * (ix+1) / (g_numFrequenciesX);

			var color = mags[ix+1][iy+1] * 255;

	  	g_graphPanel2.context.fillStyle = "rgb(" + color + ", " + color + ", "+ color + ")";
			g_graphPanel2.context.fillRect(x1, y1, x2-x1, y2-y1);

		}
	}

  g_graphPanel2.context.font = '20px serif';
  g_graphPanel2.context.fillStyle='#00FF00';	
	g_graphPanel2.context.fillText("(0,0)", 5, 25);  
}

</script>
</head>
<body>
<h1>2D Point Set Frequencies</h1>
<b>Click and drag points.  Double click on a point to remove it.  Double click on an empty space to add a point.</b><br/><br/>
<table>
	<tr>
		<td>
			<canvas class="html5" id="Graph" width="400" height="400">Your browser doesn't seem to support the necesary html5 features ):</canvas>
		</td>
		<td>
			<canvas class="html5" id="Graph2" width="400" height="400">Your browser doesn't seem to support the necesary html5 features ):</canvas>
		</td>
	</tr>
</table>
<table style="border: 1px solid #00FF00">
	<tr>
		<td>Max Frequency X:</td>
		<td><input type="text" id="numFrequenciesX" value="8" onchange="val = parseInt(document.getElementById('numFrequenciesX').value); document.getElementById('numFrequenciesX').value = val; g_numFrequenciesX = val; RedrawGraph();" /></td>
	</tr>
	<tr>
		<td>Max Frequency Y:</td>
		<td><input type="text" id="numFrequenciesY" value="8" onchange="val = parseInt(document.getElementById('numFrequenciesY').value); document.getElementById('numFrequenciesY').value = val; g_numFrequenciesY = val; RedrawGraph();" /></td>
	</tr>	
</table>
<br>
</body></html>
